% !TEX root=./tech-specification.tex
\section{内部合约}
%\section{Internal Contracts}
\label{sec:internal}
为了更好的系统维护和链上管理，\name 采用数个内置的内部合约。
%\name introduces several built-in internal contracts for better system maintenance and on-chain governance.
%

这些内部合约为开发人员提供与 Solidity 类似的交互界面。第 \ref{sec:internal_gas} 节中写明了介面列表和燃料消耗。第 \ref{sec:internal_contract} 节正式地定义了内部合约的性能。在本节中，我们将介绍内部的高层设计。
%They provide solidity-like interface for developers. The interface list and their gas consumptions are list in section~\ref{sec:internal_gas}. Section~\ref{sec:internal_contract} formally describes the behavior of internal contracts. In this section, we introduce the high-level design of internal contracts. 


\subsection{交易费代付}
%\subsection{Sponsorship for Usage of Contracts}
\label{sec:sponsor}

\name 实施一个赞助机制为智能合约的使用提供补助。
%\name implements a sponsorship mechanism to subsidize the usage of smart contracts. 
因此，如果执行得到赞助（通常由 Dapps 的操作者赞助），一个余额为零的新账户就能够调用合约。
%Thus, a new account with zero balance is able to call smart contracts as long as the execution is sponsored (usually by the operator of Dapps).
为记录智能合约的赞助信息，我们采用内置的 \emph{赞助管理合约}。 
%The built-in \emph{SponsorControl Contract} is introduced to record the sponsorship information of smart contracts.

\emph{赞助管理合约} 追踪每个由用户创建的合约 $\contract$ 的 {\bf 资助信息}，该信息包含以下域：
%The SponsorControl contract keeps the {\bf SponsorInfo} information for each user-established contract $\contract$. The {\bf SponsorInfo} contains the following fields. 
\begin{itemize}[nosep]
	\item {\bf 燃料资助人（sponsor for gas）}: 这是为燃料消耗提供补助的账户
	%\item {\bf sponsor for gas}: this is the account that provides the subsidy for gas consumption;

	\item {\bf 存储抵押资助人}: 这是为存储抵押提供补助的账户
	%\item {\bf sponsor for collateral}: this is the account that provides the subsidy for collateral for storage; 

	\item {\bf 燃料资助余额}: 这是可为燃料消耗提供补助的余额
	%\item {\bf sponsor balance for gas}: this is the balance of subsidy available for gas consumption;

	\item {\bf 存储抵押资助余额}: 这是可为存储抵提供补助的余额
	%\item {\bf sponsor balance for collateral}: this is the balance of subsidy available for collateral for storage;

	\item {\bf 燃料资助上限}:	这是可为每笔被赞助交易支付的燃料补助上限。
	%\item {\bf sponsor limit for gas fee}: this is the upper bound for the gas fee subsidy paid for every sponsored transaction;
\end{itemize}

\emph{赞助管理合约} 同时追踪每个由用户创建的合约 $\contract$ 的 {\bf 白名单}。该名单记录有资格资助使用的普通账户。一个特殊的全零地址代表所有普通账户。若 \emph{赞助管理合约} 的存储项以 $\contract_{addr}\cdot a$ 为键，以 $1$ 为值，则地址 $a$ 在合约 $\contract$ 的白名单之中。
%The SponsorControl contract also keeps a {\bf whitelist} for each user-established contract $\contract$, which records normal accounts that are eligible for the subsidy. A special all-zero address refers to all normal accounts. If the storage entry of SponsorControl contract with key $\contract_{addr}\cdot a$ is set to one, the address $a$ is in the whitelist of contract $\contract$.

所以，我们可以通过以下方法检查一个地址 $a$ 是否存在于合约 $\contract$ 的白名单中：
%So we can check if an address $a$ is in whitelist of contract $\contract$ by
\begin{align}
	\mathsf{Whitelist}(\st,a,\contract) &\eqdef \st[a_{\sf sponsor}]_{\bf s}[\contract_{addr}\cdot a]_v \neq 0 \;\vee\; \st[a_{\sf sponsor}]_{\bf s}[\contract_{addr}\cdot y]_v \neq 0 \notag \\
	\mbox{where:}&\notag \\
	y&\eqdef [0000000000000000000000000000000000000000]_2 \notag \\ 
	a_{\sf sponsor} & \eqdef \sponsorcontract \label{eq:whitelist}
\end{align}



% \medskip

\paragraph{燃料消耗资助人}
%\paragraph{Sponsor for gas consumption.}
对一个 {\bf 燃料资助人} 域值非零的合约 $\contract$ 和调用该合约的交易 $\tx$，$\tx$ 使用燃料资助的条件为：
1） $\senderf(\tx)$ 在 $\contract$ 的 \textbf{白名单} 中，
2） $\tx$ 所需的燃料费在限额之内，即 $\tx_p\times\tx_g \le \text{\textbf{sponsor limit for gas fee} of $\contract$}$。
%For a contract $\contract$ with non-empty {\bf sponsor for gas} and a transaction $\tx$ calling $\contract$, $\tx$ is eligible for the subsidy for gas consumption if $\senderf(\tx)$ is in the \textbf{whitelist} of $\contract$and the gas fee specified by $\tx$ is within the limit, i.e. $\tx_p\times\tx_g \le \text{\textbf{sponsor limit for gas fee} of $\contract$}$.
$\tx$ 的燃料消耗将（在余额充足的前提下）从 $\contract$ 的 \textbf{燃料资助余额} 中支出，而非从交易发送方的余额中支出。
%The gas consumption of $\tx$ is paid from the \textbf{sponsor balance for gas} of $\contract$ (if it is sufficient) rather than from the sender's balance,
若 \textbf{燃料资助余额} 不足以支付燃料消耗，$\tx$ 的执行将失败。
%and the execution of $\tx$ would fail if the \textbf{sponsor balance for gas} cannot afford the gas consumption.
当交易所需燃料费（即 $\tx_p\times\tx_g$）大于 $\min\set{\textbf{sponsor limit for gas fee}，\textbf{sponsor balance for gas}}$，赞助将不被提供，而交易发送方 $\sender{\tx}$ 应负责支付燃料消耗。
%In case the transaction specifies a gas fee (i.e. $\tx_p\times\tx_g$) greater than $\min\set{\textbf{sponsor limit for gas fee}, \textbf{sponsor balance for gas}}$, there is no subsidy and the sender $\sender{\tx}$ should pay for the gas consumption as usual.

\paragraph{存储抵押资助人}
%\paragraph{Sponsor for storage collateral.}
对一个 {\bf 存储抵押资助人} 域值非零的合约 $\contract$ 和调用该合约的交易 $\tx$，
%For a contract $\contract$ with non-empty {\bf sponsor for collateral} and a transaction $\tx$ calling $\contract$,
满足以下条件的 $\tx$ 有资格使用存储赞助：

1） 交易发送方 $\senderf(\tx)$ 在 $\contract$ 的 \textbf{白名单} 中，

2） $\contract$ 的 {\bf 存储抵押资助余额} 足够支付交易 {\bf 存储上限} $\tx_\ell$ 所对应的抵押款 (即 $\tx_\ell\times\collateralperbyteline$ \unit)。
%$\tx$ is eligible for the subsidy for storage usage if: 
%a) its {\bf sender} $\sender{\tx}$ is in the \textbf{whitelist} of $\contract$, and 
%b) the {\bf sponsor balance for collateral} of $\contract$ can afford its {\bf storageLimit} $\tx_\ell$ (i.e. $\tx_\ell\times\collateralperbyteline$ \unit).

若 $\tx$ 有资格使用存储补助，该交易执行过程中产生的存储抵押将从 $\contract$ 的 \textbf{存储抵押资助余额} 中扣除，且这些经过修改的存储项的所有者将被设置为 $\contract$。
%If $\tx$ is eligible, then the collateral for storage incurred in the execution of $\tx$ is deducted from \textbf{sponsor balance for collateral} of $\contract$, and the owner of those modified storage entries is set to $\contract$ accordingly.
若 $\sender{\tx}$ 不在 \textbf{白名单} 中或 \textbf{存储抵押资助余额} 不足以覆盖 {\bf 存储上限}， 交易发送方 $\sender{\tx}$ 将从其账户余额中支付燃料消耗。
%In case $\sender{\tx}$ is not in the \textbf{whitelist} or the \textbf{sponsor balance for collateral} cannot cover the {\bf storageLimit}, the sender $\sender{\tx}$ has to pay for storage usage from its own balance as usual.


\subsubsection{更新赞助设置}
%\subsubsection{Sponsorship Update}

燃料资助和抵押资助都可以通过调用 \textbf{赞助管理合约} 进行更新。
%Both sponsorship for gas and for collateral can be updated by calling the SponsorControl contract.
现任资助人可以通过调用该合约直接转账至资助余额户头，
%The current sponsors can call this contract to transfer funds to increase the sponsor balances directly,
且现任燃料资助人无需转账即可提高 \textbf{燃料资助上限}。
%and the current sponsor for gas is also allowed to increase the \textbf{sponsor limit for gas} without transferring new funds.
其他普通账户可以通过调用该合约来替换现任资助人，并提供更多资助金。
%Other normal accounts can replace the current sponsors by calling this contract and providing more funds for sponsorship.



为替换合约 $\contract$ 的 \textbf{燃料资助人}，新资助人应该将一笔多于 $\contract$ 现有 \textbf{燃料资助余额} 的资金转账到 $\contract$ 中，并设置一个新的 \textbf{燃料资助上限}。
%To replace the \textbf{sponsor for gas} of a contract $\contract$, the new sponsor should transfer to $\contract$ a fund more than the current \textbf{sponsor balance for gas} of $\contract$ and set a new value for \textbf{sponsor limit for gas fee}.
新设置的 \textbf{燃料资助上限} 应不小于其原值，
%The new value of \textbf{sponsor limit for gas fee} should be no less than the old sponsor's limit  
除非原有的 \textbf{燃料资助余额} 不足以支付原有上限。
%unless the old \textbf{sponsor balance for gas} cannot afford the old limit.
此外，为赞助至少 $1000$ 笔调用 $\contract$ 的交易，转账金额应大于新上限的 $1000$ 倍。
%Moreover, the transferred fund should be $\ge 1000$ times of the new limit, so that it is sufficient to subsidize at least $1000$  transactions calling $\contract$. 
若满足了上述条件，当前剩余的 \textbf{燃料资助余额} 将被退还给原 \textbf{燃料资助人}，
%If the above conditions are satisfied, the remaining \textbf{sponsor balance for gas} will be refunded to the old \textbf{sponsor for gas},
而 \textbf{燃料资助余额}, \textbf{燃料资助人} and \textbf{燃料资助上限} 将根据新资助人所明确的信息更新。
%and then \textbf{sponsor balance for gas}, \textbf{sponsor for gas} and \textbf{sponsor limit for gas fee} will be updated according to the new sponsor's specification.


\textbf{存储抵押资助人} 的替换使用类似的操作，除了其下没有燃料资助上限的类似项。
%The replacement of \textbf{sponsor for collateral} is similar except that there is no analog of the limit for gas fee.
新资助人应将一笔资金将转账到 $\contract$ 中，且该资金需多于 $\contract$ 现有 \textbf{存储抵押资助人} 所提供的资金。
%The new sponsor should transfer to $\contract$ a fund more than the fund provided by the current \textbf{sponsor for collateral} of $\contract$.
那么，现有 \textbf{存储抵押资助人} 将被全额退款，包含 \textbf{存储抵押资助余额} 的全额和 $\cfs(\contract)$。
%Then the current \textbf{sponsor for collateral} will be fully refunded, i.e. the sum of \textbf{sponsor balance for collateral} and $\cfs(\contract)$,
而存储抵押资助的相关域将根据新资助人的要求更改。
%and both collateral sponsorship fields are changed as the new sponsor's request accordingly.
注意，合约 $\contract$ 是接受补助的存储项的所有者，因此存储抵押资助人的替换将不影响现有存储项的所有权。
%Note that the contract $\contract$ is the owner of subsidized storage entries, so that the replacement of sponsorship for collateral will not affect ownership of existing storage entries.

\paragraph{注:} 一个合约账户也可能成为资助人。
%\paragraph{Note:} A contract account is also allowed to be a sponsor.
因此，在资助人更换之前，作为资助人的合约可能被销毁。这种情况下，资助金退款的接收方将是一个已被销毁的合约。
%Therefore it is possible that the sponsoring contract may be destructed before its sponsorship is replaced, in which case the receiver of sponsorship refund will be an already-destructed contract.
因为被销毁合约的余额无法支撑运作（除非存在 $\kec$ 的碰撞），在世界状态中记录该数字将毫无意义，因此退款将被立刻烧毁。
%Since the balance of such a contract is not operable (unless there is collision of $\kec$), it is meaningless to record that number in state and hence the refund will be burnt immediately.


\subsection{管理员控制台}
%\subsection{Admin Management}
\label{sec:admin}

我们采用 \emph{管理员控制台合约} 以更好地维护其他（尤其是没有销毁程序的）智能合约：
%The \emph{AdminControl Contract} is introduced for better maintenance of other smart contracts, espeically which are generated tentatively without a proper destruction routine:
该合约记录每个由用户创建的智能合约的管理员，并应管理员请求对合约实行销毁。
%it records the administrator of every user-established smart contract and handles the destruction on request of corresponding administrators.

合约 $\contract$ 的默认管理员是该合约的创建者，即创建 $\contract$ 的交易的发送方 $\account$。
%The default administrator of a smart contract $\contract$ is the  creator of $\contract$, i.e. the sender $\account$ of the transaction that causes the creation of $\contract$.
智能合约的现任管理员可以通过向 \emph{管理员控制台合约} 发送请求，将其权限转给另一个 \emph{普通账户}。
%The current administrator of a smart contract can transfer its authority to another \emph{normal account} by sending a request to the AdminControl contract.
合约账户不能成为其他合约的管理员，因为该机制主要为不正确的合约代码而设（作为管理员的合约账户可能有相同问题而导致该机制失效）。
%Contract accounts are not allowed to be the administrator of other contracts, since this mechanism is mainly for tentative maintenance.
任何涉及自定义授权规则的长期管理应当被植入在合约内，即作为一个管理销毁请求的特殊函数。
%Any long term administration with customized authorization rules should be implemented inside the contract, i.e. as a specific function that handles destruction requests.

在任意时刻，现有合约 $\contract$ 的管理员 $\account$ 有权力通过调用 \emph{管理员控制台合约} 请求销毁 $\contract$。
%At any time, the administrator $\account$ of an existing contract $\contract$ has the right to request destruction of $\contract$ by calling AdminControl.
但是，若合约 $\contract$ 的存储抵押不为零，即 $\cfs(\contract)>0$，或 $\account$ 不是 $\contract$ 的现任管理员，销毁请求将被拒绝。
%However, the request would be rejected if the collateral for storage of contract $\contract$ is not zero, i.e. $\cfs(\contract)>0$, or $\account$ is not the current administrator of $\contract$.
若 $\account$ 是 $\contract$ 的现任管理员且 $\cfs(\contract)=0$，则销毁请求将被同意并运行如下：
%If $\account$ is the current administrator of $\contract$ and $\cfs(\contract)=0$, then the destruction request is accepted and processed as follows:
\begin{enumerate}[nosep]
 	\item $\contract$ 的余额将被退还至 $\account$；
 	%\item the balance of $\contract$ will be refunded to $\account$; 

	\item $\contract$ 的 \textbf{燃料资助余额} 将被退款给 \textbf{燃料资助人}；
	%\item the \textbf{sponsor balance for gas} of $\contract$ will be refunded to \textbf{sponsor for gas};

	\item $\contract$ 的 \textbf{存储抵押资助余额} 将被退款给 \textbf{存储抵押资助人}；
	%\item the \textbf{sponsor balance for collateral} of $\contract$ will be refunded to \textbf{sponsor for collateral};

	\item $\contract$ 的内部状态将被释放，而其对应的存储抵押将被退还给所有者；
	%\item the internal state in $\contract$ will be released and the corresponding collateral for storage refunded to owners;

	\item 合约 $\contract$ 将从世界状态中被删除。
	%\item the contract $\contract$ is deleted from world-state.
\end{enumerate} 

合约 $a$ 的管理员被存储在账户组成部分 $a_a$ 中。
%The administrator of contract $a$ is stored in account component $a_a$. 

\subsection{Staking 机制}
%\subsection{Staking Mechanism}
\label{sec:staking}

\name 为以下两个原因启用 staking 机制：
%\name introduces the staking mechanism for two reasons:
首先，staking 机制为使用存储空间提供（与一次性支付相比）更好的收费方式；
%first, staking mechanism provides a better way to charge the occupation of storage space (comparing to ``pay once, occupy forever'');
其次，此机制协助定义了去中心化管理下的投票权。
%and second, this mechanism also helps in defining the voting power in decentralized governance.

\name 在高层内置了一个 \emph{Staking 合约} 来记录所有账户的 staking 信息。
%At a high level, \name implements a built-in \emph{Staking Contract} 
% (at address $\stakingcontract$) 
%to record the staking information of all accounts.
通过发送交易到这个合约，用户（外部用户和智能合约）可以存储或退还款项，该款项即合约中所称的 \emph{stakes}。
%By sending a transaction to this contract, users (both external users and smart contracts) can deposit/withdraw funds, which is also called \emph{stakes} in the contract.
用于 staking 的款项的利息将在退还款项时发放，该利息取决于被退还款项的 staking 款额 和 staking 周期。
%The interest of staked funds is issued at withdrawal, and depends on both the amount and staking period of the fund being withdrawn. 


在 Conflux 中，staking 合约追踪用于 staking 的款项和冻结规则。Staking 合约记录每个账户 $\account$ 的以下信息：
%In \name, the staking contract keeps track of staked funds and freezing rules. For every account $\account$ the staking contract records the following:
\begin{itemize}
	\item {\bf staking 款项}: 每个 staking 款项由发送方 $\account$ 付出款项的余额 $v\in\N_{256}$ 和创建时间 $t\in\N_{64}$ 组成。当款项被全部退还后，此项将被清除。
	%\item {\bf staking funds}: each staking fund entry consists of the balance $v\in\N_{256}$ and creation time $t\in\N_{64}$ of a staked fund from the sender $\account$, and the entry is cleared when the fund is completely withdrawn;
	

	\item {\bf 冻结规则}: 每个冻结规则项是一个组合 $(v,t)\in \N_{256}\times\N_{64}$。该项确保当（在 \hyperlink{blockno}{$\blockno$} 中定义的）区块号码不超过 $t$ 时，$\account$ 的所有 staking 余额不少于 $v$ （以 \unit 为单位）。
	%\item {\bf freezing rules}: each freezing rule entry is a combination of $(v,t)\in \N_{256}\times\N_{64}$ which promises that the total stake balance of account $\account$ must be at least $v$ (measured in \unit) as long as the block number (as defined in \hyperlink{blockno}{$\blockno$}) does not exceed $t$. 
	过期的冻结规则将在该账号 $\account$ 下次更新规则时被清除。
	%Expired freezing rule entries are cleared at the next update of freezing rules of the same account $\account$.	
\end{itemize}

Staking 合约中的以上两个项都要求存储抵押，而该抵押将在对应项被清除时退还。
%Both kinds of entries in the staking contract requires collateral for storage, and the collateral is returned at the clearance of corresponding entries.



\subsubsection{利息率}
%\subsubsection{Interest Rate}

当下 Staking 利息率设在每年 \interest。
%The staking interest rate is currently set to \interest per year.
复利以区块为单位计算。
%Compound interest is implemented in the granularity of blocks.
因此，年利率大约为 \annualinterest。
%So the annualized interest rate is about \annualinterest.

假设我们在区块 $\block$ 中执行一个由账户 $\alpha$ 发送的交易，该交易退还在区块 $\block'$ 时存入的价值为 $v$ 的款项，则利息的计算如下：
%When executing a transaction sent by account $\alpha$ at block $\block$ to withdraw a fund of value $v$ deposited at block $\block'$, the interest is calculated as follows:
\begin{align}
	\text{Interest issued to $\account$} 
	&\eqdef \left\lfloor v \times \frac{f^{(\blockno(\block))}(n)}{f^{(\blockno(\block'))}(n)} \right\rfloor- v \\ 
	\mbox{where:}& \\
	f(x) &\eqdef \left\lfloor x \times \left(1+\frac{\interest}{\blockinyear}\right)\right\rfloor \\
	n &\eqdef \blockinyear \times 2^{80}
\end{align}
利息约等于
%The interest is approximately equals to 
\begin{align}
	\left(\left(1+\frac{\interest}{\blockinyear}\right)^T-1\right)\times v, 
\end{align}
其中  $T\eqdef\blockno(\block) - \blockno(\block')$ 是由区块数量衡量的 staking 周期，而 $\blockinyear$ 是 $365$ 天内生成区块数的期望值（目标区块生成时间为 $\blocktime$ 秒）。
%where $T\eqdef\blockno(\block) - \blockno(\block')$ is the staking period measured by number of blocks, and $\blockinyear$ is the expected number of blocks generated in $365$ days with the target block time $\blocktime$ seconds.
% 
因此，在退款后 $\account$ 的 staking 款项全额减少了 $v$，而该账户余额增加了：
%Therefore after the withdrawal, $\account$'s total amount of staking funds is decreased by $v$, and its balance is increased by:
\begin{align}
	\Delta(\account_b) \eqdef v + \text{Interest issued to $\account$} 
\end{align}

账户 $\account$ 仅在退款请求中明确其值 $v$。
%The account $\account$ only specifies the value $v$ in its withdrawal request. 
退款始终从时间最早的 staking 款项开始，依次处理每一项，直到累计数额足以支付退款。
%The withdrawal always starts from the earliest staked fund and recursively continues to the next one until the accumulative amount is sufficient.

相同的利息率也应用在存储抵押上，但 CFS 利息将在每个新区块生成时直接发放给矿工，作为使用存储的费用。
%The same interest rate applies to collateral for storage as well, but the CFS interest is issued directly to the miners as the payment for storage usage at the generation of every new block.
有关 CFS 利息发放的更多细节在第 \ref{subsec:storagefee} 中有所明确。
%More details about CFS interest issuance are specified in Section~\ref{subsec:storagefee}.


\subsubsection{基于 Staking 的投票权}
%\subsubsection{Staking for Voting Power}

在去中心化管理下，staking 机制为衡量用户参与度和忠诚度提供了一个新维度 —— staking 时长。
%For decentralized governance, the staking mechanism provides a way to measure the involvement and devotion of users with the new dimension of staking age.

在决定投票权时，将 staking 时长一起纳入考虑比仅考虑代币数量更加公平合理。
%When deciding voting power, it is fair and reasonable to take the staking time into consideration,rather than merely the amount of tokens.
将投票权与承诺 staking 时长相关联可以减轻系统被攻击的风险，因为攻击者必须在一段足够长的时间内一直持有代币才能获得足够投票权，而这增加了发起攻击的成本。
%By relating voting power to committed staking period, the risk of being attacked is also mitigated, since the attacker must hold the tokens for a sufficiently long period to obtain enough voting power, which increases the cost of launching an attack.

每个账户 $\account$ 的承诺 staking 时长和 {\bf 冻结规则} 一致的格式被记录在账户域 {\bf staking 投票信息 中，
%For every account $\account$, its committed staking time is recorded in the account field {\bf staking vote info} in the form of {\bf freezing rules},
其中每一项 $(v,t)\in \N_{256}\times\N_{64}$ 代表在区块排序编号 (即 $\blockno$) 达到 $t$ 之前，$\account$ 的 staking 余额一定不少于 $v$ \unit。
%where each entry $(v,t)\in \N_{256}\times\N_{64}$ is a promise that the  staking balance of $\account$ must be at least $v$ \unit until the index of block in total order (e.g. $\blockno$) reaches $t$.
若退款的执行结果将违反任意冻结规则，$\account$ 的退款请求将是无效的。
%A withdrawal request from $\account$ is invalid if any freezing rule is violated after fulfilling that request.
每个账户的冻结规则列表仅允许追加，如此一来承诺 staking 时长不能被取消或缩短。
%The list of freezing rules for every account is append-only so that committed staking period cannot be canceled or shorten.
但是每一条规则终将随区块号码的增长而过期，即规则 $(v,t)$ 在满足 $\blockno(\block)\ge t$ 的区块 $\block$ 过期。
%However every single rule will eventually expire as the block number grows, e.g. the rule $(v,t)$ expires at block $\block$ with $\blockno(\block)\ge t$. 
过期的冻结规则项将在该账户冻结规则的下一次更新时，从内置 staking 合约的状态存储中被清除。
%Expired freezing rule entries are cleared from state storage of the built-in staking contract at the next update of freezing rules of the same account.	

注意，冻结规则和具体的 staking 款项是分离的，即只要剩余 staking 余额充足，原有款项就可被退还。
%Note that freezing rules are decoupled from specific staking funds, i.e. old funds can be withdrawn as long as the remaining staking balance is sufficient. 
因此，staking 合约可以先进先出的规则维持 staking 款项（即最早的 staking 款项也是第一个被退还的）。
%Therefore, the staking contract is allowed to maintain staked funds in a first-in-first-out manner (i.e. the earliest staked fund is also first withdrawn).


每个 staking 代币的投票权定义如下：
%The voting power of each staked token is defined in the following table:

\par
\begin{center}
\begin{tabular}{ll}
\toprule
剩余承诺 Staking 时间 & 投票权 \\
%Remaining Committed Staking Time & Voting Power \\
\midrule
大于一年 (即 $\ge \blockinyear$ 个区块) & $1$  \\
%One year or more (i.e. $\ge \blockinyear$ blocks) & $1$  \\
六个月至一年 ($\ge 31536000$ 但 $<63072000$ 个区块) & $0.5$ \\
%Six months to one year ($\ge 31536000$ but $<63072000$ blocks) & $0.5$ \\
三个月到六个月 ($\ge 15768000$ 但 $<31536000$ 个区块) & $0.25$\\
%Three to six months ($\ge 15768000$ but $<31536000$ blocks) & $0.25$\\
小于三个月 (即 $< 15768000$ 个区块) & $0$ \\
%Less than three month (i.e. $< 15768000$ blocks) & $0$ \\
\bottomrule
\end{tabular}
\end{center}
\par
因此，每个账户所有的投票权能从记录在 staking 合约内的冻结规则简单计算得到。
%Therefore the total voting power of each account can be easily calculated from its freezing rules as recorded in the staking contract.
